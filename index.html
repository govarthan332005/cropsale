<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crop Sale - Premium Agricultural Marketplace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- TailwindCSS 2.2.19 -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Google Fonts: Inter, Playfair Display, Roboto Slab -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700;900&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
  <!-- Font Awesome 6.5.2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <!-- Chart.js 4.4.3 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    html, body {
      font-family: 'Inter', 'Roboto Slab', Arial, sans-serif;
      background: linear-gradient(120deg, #f3f9f5 0%, #e0f0ff 54%, #b5e2fa 100%);
      min-height: 100vh;
      color: #13293d;
      scroll-behavior: smooth;
      box-sizing: border-box;
    }
    .font-logo { font-family: 'Playfair Display', serif; letter-spacing: -2px;}
    .font-title { font-family: 'Roboto Slab', serif;}
    .glass-bg {
      background: rgba(255,255,255,0.97);
      -webkit-backdrop-filter: blur(17px);
      backdrop-filter: blur(17px);
      border: 2px solid rgba(142,197,204,0.09);
    }
    .shadow-card {
      box-shadow: 0 10px 36px 0 rgba(29,79,175,.10), 0 2px 8px 0 rgba(80,180,140,.07);
    }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #d9f5e6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      overflow: hidden;
    }
    .fade-in {
      animation: fadeIn 0.8s cubic-bezier(0.41,0.93,0.57,1.0);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: none;}
    }
    .animate-spinner { animation: spin 0.95s linear infinite;}
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    ::-webkit-scrollbar { width: 0 !important;}
    body, * { scrollbar-width: none; -ms-overflow-style: none;}
    .feature-badge {
      display:inline-block; background:#e3ffed; color:#1db884; font-weight:600; border-radius:.75rem; font-size:.88em; padding:.11em .62em .17em .62em; margin-left:.4rem;
    }
    .transition-150 { transition: 0.15s all; }
    .hover-card:hover,.hover-card.hover { box-shadow:0 6px 20px 0 rgba(70,140,131,0.16)!important; transform:translateY(-2px) scale(1.028);}
    @media print {
      html, body { background: #fff !important; }
      nav, .fixed, .sticky { position: static !important; box-shadow: none !important;}
      .glass-bg, .shadow-card { box-shadow: none !important;}
      input, textarea, button, .glass-bg { box-shadow: none !important;}
      .print:hidden { display: none !important;}
    }
    .settings-advanced { border-top: 1px solid #dedede; margin-top: 1.5rem; padding-top: 1.25rem;}
    .settings-toggle { display:flex; align-items:center; gap:0.65em;}
    .settings-toggle input[type="checkbox"] { accent-color: #38bdf8; }
    .avatar-uploader input[type="file"] { display:none;}
    .avatar-uploader label { cursor:pointer; display:inline-block;}
    .uploader-img-preview {
      display: block;
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #9ae6b4;
    }
    @media (max-width: 700px) {
      .font-logo { font-size: 1.3rem !important;}
      header, nav { font-size: .97rem;}
    }
    .gradient-btn {
      background: linear-gradient(90deg, #22d3ee 0%, #22c55e 80%);
      color: #fff;
      font-weight: bold;
      border-radius: 9999px;
      padding: .7em 2em;
      box-shadow: 0 1px 4px rgba(80,190,140,.09);
      transition: filter .14s, box-shadow .16s;
      font-size: 1.12rem;
    }
    .gradient-btn:hover { filter: brightness(1.07);}
    /* Responsive fix for pdf */
    main, section, nav { min-width: 0; }
  </style>
</head>
<body>
<!-- LOGIN PAGE -->
<div id="login-page" class="min-h-screen flex flex-col items-center justify-center px-3 py-6 fade-in">
  <div class="w-full max-w-sm rounded-2xl shadow-card glass-bg p-10 text-center flex flex-col items-center relative border border-blue-50">
    <div class="absolute left-2 top-2 opacity-10 pointer-events-none">
      <i class="fas fa-leaf text-green-300 text-4xl"></i>
    </div>
    <h1 class="font-logo text-4xl md:text-5xl font-extrabold bg-gradient-to-tr from-green-500 via-sky-500 to-emerald-500 bg-clip-text text-transparent drop-shadow-sm tracking-tight pb-1 flex items-center gap-2 justify-center">
      <i class="fas fa-seedling text-green-400 drop-shadow"></i>
      Crop <span class="font-title text-blue-500 ml-1">Sale</span>
    </h1>
    <p class="mb-7 text-base text-gray-600 font-medium">Premium Marketplace for Modern Indian Farming <span class="feature-badge">vNext</span></p>
    <div class="w-full space-y-2 mt-1 mb-4">
      <button onclick="googleLogin()" class="w-full py-3 rounded-full font-semibold flex items-center justify-center gap-2 gradient-btn shadow hover:shadow-md focus:ring focus:ring-blue-200 transition-150">
        <i class="fab fa-google"></i> Sign in with Google
      </button>
    </div>
    <form id="email-login-form" onsubmit="emailLogin(event)" class="w-full flex flex-col items-center space-y-2 mt-2">
      <input id="login-email" type="email" autocomplete="username" placeholder="Email" required class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-green-200 focus:ring-2 bg-gray-50 text-base font-medium mb-1" />
      <input id="login-password" type="password" autocomplete="current-password" placeholder="Password" required minlength="6" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-green-200 focus:ring-2 bg-gray-50 text-base font-medium" />
      <button type="submit" class="mt-1 w-full py-3 rounded-full bg-blue-500 text-white font-semibold text-lg transition-150 hover:bg-blue-600 focus:ring-2 focus:ring-offset-2 focus:ring-blue-300 flex items-center justify-center gap-2">
        <span>Sign in</span>
        <span id="login-loading" class="hidden animate-spinner ml-2"><i class="fas fa-spinner"></i></span>
      </button>
      <div id="login-status" class="w-full text-center text-xs pt-1 text-red-400"></div>
    </form>
    <div class="mt-3 w-full text-xs text-gray-500">
      <span>Don't have an account? <a href="#" onclick="toggleSignup(true)" class="text-blue-600 underline hover:text-green-600">Sign up.</a></span>
    </div>
    <form id="email-signup-form" onsubmit="emailSignup(event)" class="w-full flex-col items-center space-y-2 mt-3 hidden">
      <input id="signup-name" type="text" autocomplete="name" placeholder="Display Name" required maxlength="32" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-green-200 focus:ring-2 bg-blue-50 text-base font-medium" />
      <input id="signup-email" type="email" autocomplete="username" placeholder="Email" required class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-green-200 focus:ring-2 bg-blue-50 text-base font-medium" />
      <input id="signup-password" type="password" autocomplete="new-password" placeholder="Password (min 6 chars)" required minlength="6" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-green-200 focus:ring-2 bg-blue-50 text-base font-medium" />
      <button type="submit" class="mt-1 w-full py-3 rounded-full bg-green-500 text-white font-semibold text-lg transition-150 hover:bg-green-600 focus:ring-2 focus:ring-offset-2 focus:ring-green-300 flex items-center justify-center gap-2">
        <span>Sign up</span>
        <span id="signup-loading" class="hidden animate-spinner ml-2"><i class="fas fa-spinner"></i></span>
      </button>
      <div id="signup-status" class="w-full text-center text-xs pt-1 text-red-400"></div>
      <div class="w-full text-xs text-gray-500 text-center mt-2">
        <span>Already have an account? <a href="#" onclick="toggleSignup(false)" class="text-blue-600 underline hover:text-green-600">Login</a></span>
      </div>
    </form>
  </div>
</div>

<!-- APP MAIN -->
<div id="app" class="hidden min-h-screen flex flex-col fade-in">
  <!-- HEADER -->
  <header class="w-full px-8 py-3 bg-white/80 shadow-card sticky top-0 z-40 flex items-center justify-between font-title transition print:relative">
    <div class="flex items-center gap-2 select-none">
      <i class="fas fa-seedling text-green-500 text-2xl"></i>
      <span class="font-logo text-3xl font-extrabold tracking-tight text-blue-500">Crop</span>
      <span class="font-title text-green-700 text-2xl font-bold ml-2 tracking-tight">Sale</span>
      <span class="feature-badge hidden lg:inline-block">All India</span>
    </div>
    <div class="flex items-center gap-6">
      <button id="geo-btn" class="text-blue-400 hover:text-green-500 text-2xl transition-150" title="Enable Geolocation">
        <i class="fas fa-location-arrow"></i>
      </button>
      <button id="avatar-btn" onclick="showSection('settings-section')" class="avatar text-xl text-white bg-gradient-to-br from-green-400 to-blue-400 border-2 border-green-300 shadow-md hover:ring-2 hover:ring-green-300 transition"></button>
    </div>
  </header>
  <!-- SEARCH BAR -->
  <div class="w-full px-8 py-2 bg-white/90 shadow-card sticky top-16 z-30 print:relative">
    <form onsubmit="searchProducts(event)" class="flex items-center w-full">
      <input 
        id="product-search"
        type="text"
        autocomplete="off"
        placeholder="üîç Search produce, products, or markets..."
        class="flex-1 bg-blue-50 focus:bg-white rounded-full px-5 py-3 text-base shadow-sm border border-gray-200 focus:ring-2 focus:ring-green-200 transition-150 placeholder-gray-400 outline-none font-title"
      />
      <button type="submit" class="ml-2 p-2 text-blue-500 hover:bg-blue-100 transition-150 rounded-full">
        <i class="fas fa-search fa-lg"></i>
      </button>
    </form>
  </div>
  <!-- MAIN CONTENT -->
  <main class="w-full flex-1 px-2 md:px-10 py-7 md:py-14 bg-transparent flex flex-col items-center gap-12 print:gap-8 overflow-visible" style="min-height:540px;">
    <!-- BUY SECTION -->
    <section id="buy-section" class="w-full max-w-6xl mx-auto print:relative">
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-[1.7rem] md:text-2xl font-bold text-blue-700 tracking-tight uppercase font-title">Available Products</h2>
        <button onclick="reloadProducts()" class="bg-green-100 text-blue-600 p-2 rounded-full hover:bg-green-200 transition-150" title="Reload Products">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div id="products-list" class="w-full grid gap-7 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"></div>
      <div id="products-empty" class="w-full text-center text-gray-400 pt-12 hidden">
        <i class="fas fa-leaf fa-2x mb-2"></i>
        <div class="mt-2">No products found.</div>
      </div>
    </section>
    <!-- SELL SECTION -->
    <section id="sell-section" class="w-full max-w-lg mx-auto hidden print:relative">
      <div class="text-2xl font-bold text-blue-700 mb-4 font-title">Sell Your Product 
        <span class="feature-badge">Photo & Description</span>
      </div>
      <form id="sell-form" onsubmit="addProduct(event)" class="space-y-5 glass-bg rounded-xl shadow-card p-7">
        <div>
          <label class="block mb-1 font-bold text-gray-700 font-title" for="product-name">Product Name</label>
          <input required id="product-name" name="product-name" type="text" maxlength="38" class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-blue-200 focus:ring-2 bg-blue-50"/>
        </div>
        <div>
          <label class="block mb-1 font-bold text-gray-700 font-title" for="product-price">Price (‚Çπ per unit/kg)</label>
          <input required id="product-price" name="product-price" type="number" min="1" step="0.1" class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-blue-200 focus:ring-2 bg-blue-50"/>
        </div>
        <div>
          <label class="block mb-1 font-bold text-gray-700 font-title">Description</label>
          <textarea id="product-description" name="product-description" rows="3" maxlength="144" required class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-blue-200 focus:ring-2 bg-blue-50"></textarea>
        </div>
        <div>
          <label class="block mb-2 font-bold text-gray-700 font-title mb-1">Product Image</label>
          <input required id="product-image" type="file" accept="image/*" class="block w-full"/>
        </div>
        <button type="submit" class="w-full mt-2 py-3 rounded-full gradient-btn text-lg flex justify-center gap-2">
          <span>Add Product</span>
          <span id="sell-loading" class="hidden animate-spinner ml-2"><i class="fas fa-spinner"></i></span>
        </button>
        <div id="sell-status" class="text-center text-base py-1"></div>
      </form>
    </section>
    <!-- MARKET PRICES SECTION -->
    <section id="prices-section" class="w-full max-w-3xl hidden print:relative">
      <div class="flex items-center gap-2 mb-2">
        <h2 class="text-2xl font-bold text-blue-700 tracking-tight flex-1 font-title">Nearby Market Prices</h2>
        <form onsubmit="searchMarketPrices(event)" class="flex items-center gap-2 flex-1">
          <input id="market-location-search" type="text" placeholder="Type location (e.g. Mandya)..."
            class="bg-blue-50 rounded-full px-4 py-2 flex-1 border border-blue-200 focus:ring-2 focus:ring-green-200 transition-150 placeholder-gray-400 outline-none font-title"
            style="width:144px;"
          />
          <button type="submit" class="ml-2 p-2 text-blue-500 hover:bg-blue-100 transition-150 rounded-full">
            <i class="fas fa-search"></i>
          </button>
        </form>
      </div>
      <div class="w-full my-2">
        <canvas id="prices-chart" height="110"></canvas>
      </div>
      <div id="prices-list" class="w-full mt-6 grid gap-4 sm:grid-cols-2"></div>
      <div id="prices-empty" class="w-full text-center text-gray-400 pt-10 hidden">
        <i class="fas fa-info-circle fa-2x mb-2"></i>
        <div class="mt-2">No price data found for this location.</div>
      </div>
    </section>
    <!-- CART SECTION -->
    <section id="cart-section" class="w-full max-w-xl hidden print:relative">
      <div class="flex items-center mb-3">
        <h2 class="text-2xl font-bold text-blue-700 tracking-tight flex-1 font-title">Your Cart</h2>
        <button onclick="reloadCart()" class="bg-blue-100 text-blue-600 p-2 rounded-full hover:bg-blue-200 transition-150" title="Reload Cart">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div id="cart-list" class="w-full flex flex-col gap-3"></div>
      <div id="cart-empty" class="w-full text-center text-gray-400 pt-7 hidden">
        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
        <div class="mt-2">Your cart is empty.</div>
      </div>
      <div id="cart-summary" class="w-full py-3"></div>
    </section>
    <!-- SETTINGS SECTION -->
    <section id="settings-section" class="w-full max-w-md hidden print:relative">
      <div class="text-2xl font-bold text-blue-700 mb-7 font-title">Account Settings</div>
      <form id="user-settings-form" onsubmit="updateProfile(event)" class="space-y-5 glass-bg p-7 rounded-xl shadow-card">
        <div class="flex flex-col items-center mb-3">
          <div class="avatar-uploader relative">
            <input type="file" id="avatar-upload" accept="image/*" />
            <label for="avatar-upload" title="Upload new avatar">
              <span id="settings-avatar" class="avatar text-xl text-white bg-gradient-to-br from-green-400 to-blue-400 border-2 border-green-300 shadow-md mb-2"></span>
              <span class="text-xs absolute bottom-2 right-0 bg-white border border-green-200 rounded-full px-1.5 text-green-600" style="box-shadow:0 1px 4px 0 rgba(0,0,0,0.08)">üñº</span>
            </label>
          </div>
          <span id="settings-name" class="font-semibold text-lg"></span>
          <span id="settings-email" class="text-xs text-gray-400"></span>
        </div>
        <div>
          <label class="block mb-1 font-bold text-gray-700 font-title">Display Name</label>
          <input name="settings-display-name" id="settings-display-name" type="text" maxlength="32" class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-blue-200 focus:ring-2 bg-blue-50"/>
        </div>
        <div>
          <label class="block mb-1 font-bold text-gray-700 font-title">Language</label>
          <select id="settings-language" class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-blue-200 focus:ring-2 bg-blue-50">
            <option value="en">English</option>
            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
            <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
            <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
            <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
            <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
          </select>
        </div>
        <div>
          <label class="block mb-1 font-bold text-gray-700 font-title">Theme</label>
          <div class="settings-toggle">
            <input type="checkbox" id="theme-toggle" /> <span>Dark Mode</span>
          </div>
        </div>
        <div class="settings-advanced">
          <div class="settings-toggle">
            <input type="checkbox" id="notif-toggle" checked>
            <span>Enable notifications (demo)</span>
          </div>
          <div class="text-xs text-gray-400 mt-1">Advanced features coming soon.</div>
        </div>
        <div>
          <button type="submit" class="w-full py-3 rounded-full gradient-btn text-lg flex justify-center gap-2">
            <span>Update Profile</span>
            <span id="settings-loading" class="hidden animate-spinner ml-2"><i class="fas fa-spinner"></i></span>
          </button>
        </div>
        <div id="settings-status" class="text-center text-base py-1"></div>
        <div class="w-full text-center mt-6">
          <button type="button" onclick="logout()" class="text-red-500 hover:text-red-700 underline text-base font-semibold">Logout</button>
        </div>
      </form>
    </section>
  </main>
  <!-- FOOTER NAVIGATION -->
  <nav class="w-full max-w-6xl mx-auto bg-white/90 shadow-card fixed left-0 right-0 bottom-0 md:bottom-auto flex items-center justify-around py-2 z-50 ring-1 ring-blue-50 md:relative md:rounded-lg md:my-10 font-title print:relative">
    <button class="flex-1 py-1 flex flex-col items-center group" onclick="showSection('buy-section')">
      <i class="fas fa-store text-lg group-hover:text-green-500 transition-150"></i>
      <span class="text-xs text-blue-700 group-hover:text-green-700">Buy</span>
    </button>
    <button class="flex-1 py-1 flex flex-col items-center group" onclick="showSection('sell-section')">
      <i class="fas fa-plus-circle text-lg group-hover:text-green-500 transition-150"></i>
      <span class="text-xs text-blue-700 group-hover:text-green-700">Sell</span>
    </button>
    <button class="flex-1 py-1 flex flex-col items-center group" onclick="showSection('cart-section')">
      <i class="fas fa-shopping-cart text-lg group-hover:text-green-500 transition-150"></i>
      <span class="text-xs text-blue-700 group-hover:text-green-700">Cart</span>
    </button>
    <button class="flex-1 py-1 flex flex-col items-center group" onclick="showSection('prices-section')">
      <i class="fas fa-chart-line text-lg group-hover:text-green-500 transition-150"></i>
      <span class="text-xs text-blue-700 group-hover:text-green-700">Prices</span>
    </button>
    <button class="flex-1 py-1 flex flex-col items-center group" onclick="showSection('settings-section')">
      <i class="fas fa-user-cog text-lg group-hover:text-green-500 transition-150"></i>
      <span class="text-xs text-blue-700 group-hover:text-green-700">Settings</span>
    </button>
  </nav>
</div>

<!-- MODALS -->
<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-25 z-50 hidden flex items-center justify-center transition-150">
  <div id="modal-message" class="bg-white rounded-xl p-7 shadow-xl font-semibold text-lg text-gray-700"></div>
</div>
<div id="snackbar" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 z-50 px-4 py-3 bg-blue-500 text-white rounded-lg shadow-lg font-medium"></div>

<script>
  // Firebase Initialize
  const firebaseConfig = {
      apiKey: "AIzaSyDixufxD2KlUSPgqPIJQNatpQ0XEnpTouA",
      authDomain: "lumilearn-df84e.firebaseapp.com",
      databaseURL: "https://lumilearn-df84e-default-rtdb.firebaseio.com",
      projectId: "lumilearn-df84e",
      storageBucket: "lumilearn-df84e.appspot.com",
      messagingSenderId: "972914519676",
      appId: "1:972914519676:web:8c4c2a47beb1864954e3f9",
      measurementId: "G-4LZM3VLSSS"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // State
  let currentUser = null;
  let products = [];
  let priceChart = null;
  let geoLocation = null;
  let settingsAvatarFile = null;

  // UI toolkit
  function showSnackbar(message, duration=2400) {
    const snackbar = document.getElementById('snackbar');
    snackbar.textContent = message;
    snackbar.classList.remove('hidden');
    setTimeout(() => snackbar.classList.add('hidden'), duration);
  }
  function showModal(message, timeout=0) {
    document.getElementById('modal-message').innerHTML = message;
    document.getElementById('modal-backdrop').classList.remove('hidden');
    if(timeout) setTimeout(hideModal, timeout);
  }
  function hideModal() {
    document.getElementById('modal-backdrop').classList.add('hidden');
  }
  function toggleSignup(signup) {
    document.getElementById('email-login-form').classList.toggle('hidden', signup);
    document.getElementById('email-signup-form').classList.toggle('hidden', !signup);
    document.getElementById('login-status').textContent = '';
    document.getElementById('signup-status').textContent = '';
  }

  // Section Switching
  function showSection(section) {
    ['buy-section','sell-section','cart-section','prices-section','settings-section'].forEach(id =>
      document.getElementById(id).classList.add('hidden')
    );
    document.getElementById(section).classList.remove('hidden');
    if(section === 'settings-section') setSettingsForm();
    if(section === 'cart-section') loadCart();
    if(section === 'prices-section') loadPrices();
    if(section === 'buy-section') loadProducts();
    document.activeElement && document.activeElement.blur && document.activeElement.blur();
  }

  // Auth
  function googleLogin() {
    showModal("Signing in with Google...");
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(() => { hideModal(); })
      .catch(() => {
        hideModal();
        showSnackbar('Login cancelled');
      });
  }
  function emailLogin(ev) {
    ev.preventDefault();
    document.getElementById('login-loading').classList.remove('hidden');
    document.getElementById('login-status').textContent = '';
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-password').value;
    auth.signInWithEmailAndPassword(email,pass)
      .then(() => {
        document.getElementById('login-loading').classList.add('hidden');
      })
      .catch(e => {
        document.getElementById('login-loading').classList.add('hidden');
        document.getElementById('login-status').textContent = (e.code === "auth/wrong-password") ? "Wrong password." : (e.message || "Failed, try again");
      });
  }
  function emailSignup(ev) {
    ev.preventDefault();
    document.getElementById('signup-loading').classList.remove('hidden');
    document.getElementById('signup-status').textContent = '';
    const name = document.getElementById('signup-name').value.trim();
    const email = document.getElementById('signup-email').value.trim();
    const pass = document.getElementById('signup-password').value;
    auth.createUserWithEmailAndPassword(email, pass)
      .then(userCred => userCred.user.updateProfile({displayName: name}))
      .then(() => {
        document.getElementById('signup-loading').classList.add('hidden');
        toggleSignup(false);
        showSnackbar('Sign up successful! Please login.');
      })
      .catch(e => {
        document.getElementById('signup-loading').classList.add('hidden');
        document.getElementById('signup-status').textContent = (e.code === "auth/email-already-in-use") ? "Email already in use." : (e.message || "Signup error.");
      });
  }
  function logout() {
    auth.signOut().then(() => location.reload());
  }

  function onAuth(user) {
    currentUser = user;
    if(user) {
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('app').classList.remove('hidden');
      setAvatar(document.getElementById('avatar-btn'), user.displayName, user.photoURL, user.email);
      showSection('buy-section');
      db.collection('users').doc(user.uid).set({
        name: user.displayName || user.email,
        email: user.email,
        photoURL: user.photoURL || null,
        updatedAt: new Date()
      }, { merge: true });
    } else {
      document.getElementById('login-page').style.display = '';
      document.getElementById('app').classList.add('hidden');
    }
  }
  auth.onAuthStateChanged(onAuth);

  // Avatar Utility
  function setAvatar(el, displayName, photoURL, email) {
    if(photoURL) {
      el.innerHTML = `<img src="${photoURL}" class="w-full h-full rounded-full object-cover"/>`;
    } else {
      const initials = (displayName||email||'').match(/\b\w/g)?.join('').substring(0,2).toUpperCase() || '?';
      el.innerHTML = `<span class="text-blue-700 font-extrabold">${initials}</span>`;
    }
  }

  // Products (includes image fix)
  async function loadProducts(search='') {
    showProductsLoading();
    let ref = db.collection("products").orderBy("createdAt","desc").limit(36);
    if(search) {
      ref = ref.where("search", "array-contains", search.toLowerCase());
    }
    const snap = await ref.get();
    products = [];
    snap.forEach(doc => {
      products.push({id: doc.id, ...doc.data()});
    });
    renderProducts();
  }
  function showProductsLoading() {
    const el = document.getElementById('products-list');
    el.innerHTML = `<div class='w-full flex justify-center py-8'><i class='fas fa-spinner animate-spin text-2xl text-blue-400'></i></div>`;
  }
  function fixImageURL(url) {
    // If url is invalid, returns a fallback icon.
    if(url && /^https?:\/\//.test(url)) return url;
    return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f33e.svg";
  }
  function renderProducts() {
    const el = document.getElementById('products-list');
    el.innerHTML = '';
    if(!products.length) {
      document.getElementById('products-empty').classList.remove('hidden');
      return;
    }
    document.getElementById('products-empty').classList.add('hidden');
    products.forEach(prod => {
      const card = document.createElement('div');
      card.className = 'rounded-2xl glass-bg border border-blue-100 p-3 flex flex-col shadow-card hover-card transition-150 gap-2 font-title';
      card.innerHTML = `
        <img loading="lazy" src="${fixImageURL(prod.imageURL)}" alt="${prod.name}" class="rounded-xl w-full h-36 object-cover mb-2 border border-blue-50 bg-blue-50"/>
        <div class="font-bold text-blue-800 text-lg truncate">${prod.name}</div>
        <div class="text-gray-600 text-sm min-h-[2.67em] truncate">${prod.description || ''}</div>
        <div class="flex items-center justify-between mt-1 mb-2">
          <span class="text-blue-600 font-semibold text-base">‚Çπ${prod.price} <span class="text-xs text-gray-400">/kg</span></span>
          <span class="text-xs bg-blue-100 text-green-600 px-2 py-0.5 rounded capitalize">${prod.sellerName||'Unknown'}</span>
        </div>
        <div class="flex gap-2">
          <button class="w-full py-2 rounded-lg border border-green-300 text-green-600 font-semibold hover:bg-green-50 transition-150 text-base flex items-center justify-center gap-1" onclick="addToCart('${prod.id}')">
            <i class="fas fa-cart-plus"></i>Add to Cart
          </button>
          <button class="w-full py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-150 text-base flex items-center justify-center gap-1" onclick="buyNow('${prod.id}')">
            <i class="fas fa-bolt"></i>Buy
          </button>
        </div>
      `;
      el.appendChild(card);
    });
  }
  function reloadProducts() {
    if(document.getElementById('product-search').value.length)
      searchProducts(event, true);
    else
      loadProducts();
  }
  async function searchProducts(event, noScroll) {
    event && event.preventDefault();
    const term = document.getElementById('product-search').value.trim().toLowerCase();
    await loadProducts(term);
    if(!noScroll)
      document.getElementById('products-list').scrollIntoView({behavior:'smooth'});
  }

  // Sell Product
  document.getElementById('sell-form').addEventListener('input', function() {
    document.getElementById('sell-status').textContent = '';
  });
  async function addProduct(ev) {
    ev.preventDefault();
    const name = document.getElementById('product-name').value.trim();
    const desc = document.getElementById('product-description').value.trim();
    const price = Number(document.getElementById('product-price').value.trim());
    const imgFile = document.getElementById('product-image').files[0];
    if(!name || !desc || !price || !imgFile) return;
    if(imgFile.size > 3*1024*1024) {
      document.getElementById('sell-status').textContent = "Image file too large (max 3MB).";
      return;
    }
    document.getElementById('sell-loading').classList.remove('hidden');
    document.getElementById('sell-status').textContent = '';
    try {
      const fname = `prod_${currentUser.uid}_${Date.now()}_${imgFile.name.replace(/\s+/g,'_')}`;
      const snap = await storage.ref().child('product_images/'+fname).put(imgFile);
      const url = await snap.ref.getDownloadURL();
      await db.collection('products').add({
        name, description: desc, price, seller: currentUser.uid, sellerName: currentUser.displayName||currentUser.email,
        imageURL: url, createdAt: new Date(),
        search: [name,desc].join(" ").toLowerCase().split(/\s+/).filter(Boolean)
      });
      document.getElementById('sell-form').reset();
      showSnackbar('Product uploaded!');
      loadProducts();
    } catch (e) {
      document.getElementById('sell-status').textContent = "Failed to upload. Please check connection.";
    }
    document.getElementById('sell-loading').classList.add('hidden');
  }

  // Cart
  async function addToCart(pid) {
    if(!currentUser) return;
    await db.collection('carts').doc(currentUser.uid).set({
      items: firebase.firestore.FieldValue.arrayUnion(pid),
      updatedAt: new Date()
    }, {merge: true});
    showSnackbar('Added to cart');
  }
  async function buyNow(pid) {
    showModal('<i class="fas fa-info-circle text-blue-400"></i> <span class="font-title">Demo mode: direct purchase is disabled.<br/>Please contact the seller directly.</span>',1700);
  }
  async function loadCart() {
    const el = document.getElementById('cart-list');
    el.innerHTML = `<div class='w-full flex justify-center py-6'><i class='fas fa-spinner animate-spin text-2xl text-green-600'></i></div>`;
    if(!currentUser) return;
    const snap = await db.collection('carts').doc(currentUser.uid).get();
    let ids = [];
    if(snap.exists) ids = snap.data().items||[];
    if(!ids.length) {
      document.getElementById('cart-empty').classList.remove('hidden');
      el.innerHTML = '';
      document.getElementById('cart-summary').innerHTML = '';
      return;
    }
    document.getElementById('cart-empty').classList.add('hidden');
    const prods = await Promise.all(ids.map(pid => db.collection('products').doc(pid).get()));
    let total = 0;
    el.innerHTML = '';
    prods.forEach(doc => {
      if(!doc.exists) return;
      const d = doc.data();
      total += Number(d.price)||0;
      const card = document.createElement('div');
      card.className = 'glass-bg border rounded-lg p-3 flex gap-3 items-center shadow-card font-title hover-card transition-150';
      card.innerHTML = `
        <img src="${fixImageURL(d.imageURL)}" alt="${d.name}" class="w-20 h-20 object-cover rounded-md border"/>
        <div class="flex-1 min-w-0">
          <div class="font-bold text-blue-800 text-lg truncate">${d.name}</div>
          <div class="text-blue-600 text-base"><b>‚Çπ${d.price}</b></div>
          <div class="text-xs text-gray-600 truncate">${d.description}</div>
        </div>
        <button class="text-red-400 hover:text-red-600" onclick="removeFromCart('${doc.id}')"><i class="fas fa-trash"></i></button>
      `;
      el.appendChild(card);
    });
    document.getElementById('cart-summary').innerHTML = `
      <div class="w-full mt-3 bg-blue-50 rounded-lg p-3 text-base font-semibold flex items-center justify-between">
        <span>Total Items: ${prods.length}</span>
        <span>Total: ‚Çπ${total}</span>
      </div>
    `;
  }
  async function removeFromCart(pid) {
    await db.collection('carts').doc(currentUser.uid).set({
      items: firebase.firestore.FieldValue.arrayRemove(pid),
      updatedAt: new Date()
    }, {merge:true});
    showSnackbar('Removed from cart');
    loadCart();
  }
  function reloadCart() { loadCart(); }

  // Settings/Profile
  function setSettingsForm() {
    const u = currentUser;
    document.getElementById('settings-name').textContent = u.displayName||'Unknown';
    document.getElementById('settings-email').textContent = u.email;
    setAvatar(document.getElementById('settings-avatar'), u.displayName, u.photoURL, u.email);
    document.getElementById('settings-display-name').value = u.displayName||'';
    document.getElementById('settings-language').value = localStorage.getItem('crop_lang')||'en';
    document.getElementById('theme-toggle').checked = !!parseInt(localStorage.getItem('crop_theme_dark')||'0');
    document.getElementById("notif-toggle").checked = localStorage.getItem('crop_notif')!=='0';
  }
  async function updateProfile(ev) {
    ev.preventDefault();
    document.getElementById('settings-loading').classList.remove('hidden');
    document.getElementById('settings-status').textContent = '';
    try {
      const name = document.getElementById('settings-display-name').value.trim();
      if(name && currentUser.displayName !== name) {
        await currentUser.updateProfile({displayName:name});
        await db.collection('users').doc(currentUser.uid).set({name},{merge:true});
        setAvatar(document.getElementById('avatar-btn'), name, currentUser.photoURL, currentUser.email);
        showSnackbar('Profile updated!');
      }
      // Language
      const lang = document.getElementById('settings-language').value;
      localStorage.setItem('crop_lang', lang);
      // Theme
      const dark = document.getElementById('theme-toggle').checked;
      localStorage.setItem('crop_theme_dark', dark ? '1':'0');
      setThemeMode(dark);
      // Notifications
      localStorage.setItem('crop_notif', document.getElementById('notif-toggle').checked ? '1':'0');
      // Avatar update
      if (settingsAvatarFile) {
        const fname = `avatar_${currentUser.uid}_${Date.now()}.${settingsAvatarFile.name.split('.').pop()}`;
        const snap = await storage.ref().child('avatar/'+fname).put(settingsAvatarFile);
        const url = await snap.ref.getDownloadURL();
        await currentUser.updateProfile({photoURL:url});
        await db.collection('users').doc(currentUser.uid).set({photoURL:url},{merge:true});
        setAvatar(document.getElementById('settings-avatar'), name, url, currentUser.email);
        setAvatar(document.getElementById('avatar-btn'), name, url, currentUser.email);
        showSnackbar('Avatar changed!');
        settingsAvatarFile = null;
      }
      setSettingsForm();
      document.getElementById('settings-status').textContent = 'Updated!';
    }catch{ document.getElementById('settings-status').textContent = "Couldn't update profile." }
    document.getElementById('settings-loading').classList.add('hidden');
  }

  // Advanced: theme mode
  function setThemeMode(dark){
    if(dark) {
      document.documentElement.classList.add('dark');
      document.body.style.background = '#111a23';
      document.body.style.color = '#f9fafa';
      document.querySelectorAll(".glass-bg, .shadow-card").forEach(e=>{ if (e) e.style.background="#16212b"; });
    } else {
      document.documentElement.classList.remove('dark');
      document.body.style.background = "linear-gradient(120deg, #f3f9f5 0%, #e0f0ff 54%, #b5e2fa 100%)";
      document.body.style.color = "#13293d";
      document.querySelectorAll(".glass-bg, .shadow-card").forEach(e=>{ if (e) e.style.background="rgba(255,255,255,0.97)"; });
    }
  }

  // Avatar uploader logic
  document.getElementById('avatar-upload').addEventListener('change', function(ev){
    if(ev.target.files && ev.target.files[0]){
      settingsAvatarFile = ev.target.files[0];
      const url = URL.createObjectURL(ev.target.files[0]);
      document.getElementById('settings-avatar').innerHTML = `<img src="${url}" class="uploader-img-preview"/>`;
    }
  });

  // Market Prices
  async function loadPrices(locationQuery) {
    // Demo data
    let marketPrices = [
      { market:'Mandya', product:'Tomato', price:21, time:'2024-06-11' },
      { market:'Mandya', product:'Onion', price:31, time:'2024-06-11' },
      { market:'Mandya', product:'Potato', price:15, time:'2024-06-11' },
      { market:'Channapatna', product:'Tomato', price:20, time:'2024-06-11' },
      { market:'Channapatna', product:'Onion', price:29, time:'2024-06-11' },
      { market:'Channapatna', product:'Potato', price:16, time:'2024-06-11' },
      { market:'Ramanagara', product:'Tomato', price:22, time:'2024-06-11' },
      { market:'Ramanagara', product:'Onion', price:32, time:'2024-06-11' },
      { market:'Ramanagara', product:'Potato', price:17, time:'2024-06-11' }
    ];
    const locEl = document.getElementById('market-location-search');
    let location = (locationQuery || locEl.value || '').trim().toLowerCase();
    let selected = marketPrices;
    if(location) selected = selected.filter(e => e.market.toLowerCase().includes(location));
    if(geoLocation && !location) selected = marketPrices.filter(e => e.market === 'Mandya');
    showMarketPrices(selected);
  }
  function searchMarketPrices(ev) {
    ev.preventDefault();
    loadPrices();
    document.getElementById('prices-list').scrollIntoView({behavior:'smooth'});
  }
  function showMarketPrices(data) {
    const el = document.getElementById('prices-list');
    el.innerHTML = '';
    if(!data.length) {
      document.getElementById('prices-empty').classList.remove('hidden');
    } else {
      document.getElementById('prices-empty').classList.add('hidden');
    }
    data.forEach(p => {
      const card = document.createElement('div');
      card.className = "glass-bg rounded-lg border border-blue-100 p-3 flex flex-col gap-1 shadow-card font-title hover-card";
      card.innerHTML = `
        <div class="font-bold text-blue-700 text-base flex-1">${p.product}</div>
        <div class="text-base text-green-500 font-semibold">‚Çπ${p.price} <span class="text-xs text-gray-400">/kg</span></div>
        <div class="text-xs text-blue-400">${p.market}, ${p.time}</div>
      `;
      el.appendChild(card);
    });
    // Chart rendering
    if(data.length) {
      const products = [...new Set(data.map(e => e.product))];
      const pricesByProduct = products.map(prod => data.find(e => e.product===prod)?.price||0);
      if(priceChart) priceChart.destroy();
      priceChart = new Chart(document.getElementById('prices-chart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: products,
          datasets: [{
            label: 'Price (‚Çπ/kg)',
            data: pricesByProduct,
            backgroundColor: ['#8ee095','#86caf0','#ffe082'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {legend:{display:false}},
          responsive:true,
          scales: {y:{beginAtZero:true, grid:{display:false}}},
          animation: false
        }
      });
    } else if(priceChart) {
      priceChart.destroy();
      priceChart = null;
    }
  }

  // Geolocation
  document.getElementById('geo-btn').onclick = function() {
    if(!navigator.geolocation) return showSnackbar('Geolocation not supported');
    showSnackbar('Locating...');
    navigator.geolocation.getCurrentPosition(pos => {
      geoLocation = pos.coords;
      showSnackbar('Located! Showing nearby prices...');
      showSection('prices-section');
    }, () => showSnackbar('Location access denied'));
  };

  // Theme toggle
  document.getElementById('theme-toggle').addEventListener('change',e=>{
    setThemeMode(e.target.checked);
  });

  // Language selector (demo effect)
  document.getElementById('settings-language').addEventListener('change',e=>{
    const lang = e.target.value;
    localStorage.setItem('crop_lang', lang);
    showSnackbar('Language preference updated (refresh to apply)');
  });

  // Notification toggle (demo)
  document.getElementById('notif-toggle').addEventListener('change',e=>{
    localStorage.setItem('crop_notif', e.target.checked?'1':'0');
  });

  // UI Events on Load
  window.addEventListener('pageshow', function() {
    if(currentUser) {
      setAvatar(document.getElementById('avatar-btn'), currentUser.displayName, currentUser.photoURL, currentUser.email);
    }
  });
  window.addEventListener('DOMContentLoaded', () => {
    showSection('buy-section');
    // Set language and theme from localStorage
    setThemeMode(!!parseInt(localStorage.getItem('crop_theme_dark')||'0'));
    document.getElementById('market-location-search').addEventListener('keydown', function(e){
      if(e.code==="Enter") { e.stopPropagation(); }
    });
  });
  if(window.matchMedia) {
    window.matchMedia('print').addEventListener && window.matchMedia('print').addEventListener('change',e=>{
      if(e.matches) { document.querySelector('nav').classList.add('hidden'); }
      else { document.querySelector('nav').classList.remove('hidden'); }
    });
  }
</script>
</body>
</html>
